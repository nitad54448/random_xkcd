<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random xkcd Comic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            /* Default background color */
            background-color: #f8fafc; 
            /* Smooth transition for background color changes */
            transition: background-color 0.5s ease;
        }
        main {
            flex-grow: 1;
        }
        header, footer {
            transition: background-color 0.5s ease;
        }
        #comic-container {
            /* The container's background will be set by JS to match the body */
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        #comic-container img {
            max-width: 100%;
            height: auto;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        #loading {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-4xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center">
            <h1 id="header-title" class="text-3xl font-bold leading-tight text-gray-900 transition-colors duration-500">Random xkcd Comic</h1>
            <p id="header-subtitle" class="mt-2 text-md text-gray-600 transition-colors duration-500">Welcome! This page displays a random xkcd comic. Just refresh the page to see a new one.</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="py-6"> <!-- Reduced padding from py-10 to py-6 -->
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Loading Spinner -->
            <div id="loading" class="text-center">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"></div>
                <p class="mt-4 text-lg text-gray-600">Fetching a comic for you...</p>
            </div>

            <!-- Comic Container -->
            <div id="comic-container" class="hidden p-6 rounded-lg">
                <h2 id="comic-title" class="text-2xl font-bold text-center mb-4 transition-colors duration-500"></h2>
                <div id="comic-image-wrapper" class="mb-4">
                    <!-- Comic image will be inserted here -->
                </div>
                <p id="comic-alt" class="text-center italic transition-colors duration-500"></p>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white mt-auto">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500 transition-colors duration-500">
            <p id="footer-text">All comics are from <a id="footer-link" href="https://xkcd.com/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">xkcd.com</a>, by Randall Munroe.</p>
            <p id="footer-license" class="mt-1">Used under the Creative Commons Attribution-NonCommercial 2.5 License.</p>
        </div>
    </footer>

    <script>
        // Element references
        const body = document.body;
        const header = document.querySelector('header');
        const footer = document.querySelector('footer');
        const loadingDiv = document.getElementById('loading');
        const comicContainer = document.getElementById('comic-container');
        const comicTitle = document.getElementById('comic-title');
        const comicImageWrapper = document.getElementById('comic-image-wrapper');
        const comicAlt = document.getElementById('comic-alt');
        const headerTitle = document.getElementById('header-title');
        const headerSubtitle = document.getElementById('header-subtitle');
        const footerText = document.getElementById('footer-text');
        const footerLink = document.getElementById('footer-link');
        const footerLicense = document.getElementById('footer-license');

        const PROXY_URL = 'https://corsproxy.io/?';

        async function fetchJson(url) {
            const response = await fetch(`${PROXY_URL}${encodeURIComponent(url)}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for URL ${url}`);
            return response.json();
        }

        async function fetchRandomComic() {
            try {
                const latestComicData = await fetchJson('https://xkcd.com/info.0.json');
                const maxNum = latestComicData.num;

                let randomNum;
                do {
                    randomNum = Math.floor(Math.random() * maxNum) + 1;
                } while (randomNum === 404);

                const comicData = await fetchJson(`https://xkcd.com/${randomNum}/info.0.json`);
                displayComic(comicData);
            } catch (error) {
                console.error("Failed to fetch comic:", error);
                comicTitle.textContent = "Oops! Something went wrong.";
                comicAlt.textContent = "Could not load a comic. Please try refreshing the page.";
                setPageTheme([248, 250, 252]); // Default to gray-50 on error
                showComicContainer();
            }
        }
        
        function setPageTheme(bgColorRgb) {
            const [r, g, b] = bgColorRgb;
            const bgColor = `rgb(${r}, ${g}, ${b})`;
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;

            // Apply background color to the whole page and the container
            body.style.backgroundColor = bgColor;
            comicContainer.style.backgroundColor = bgColor;

            // Adjust UI elements for readability based on background brightness
            if (brightness < 128) {
                // Dark background
                header.style.backgroundColor = 'transparent';
                header.classList.remove('shadow-sm');
                footer.style.backgroundColor = 'transparent';
                comicContainer.classList.remove('shadow-md');

                // Set text colors to light shades
                headerTitle.style.color = '#f1f5f9'; // slate-100
                headerSubtitle.style.color = '#cbd5e1'; // slate-300
                comicTitle.style.color = '#f1f5f9';
                comicAlt.style.color = '#cbd5e1';
                footerText.style.color = '#94a3b8'; // slate-400
                footerLink.style.color = '#60a5fa'; // blue-400
                footerLicense.style.color = '#94a3b8';

            } else {
                // Light background
                header.style.backgroundColor = 'white';
                header.classList.add('shadow-sm');
                footer.style.backgroundColor = 'white';
                comicContainer.classList.add('shadow-md');

                // Reset text colors to default dark shades
                headerTitle.style.color = ''; // Revert to CSS
                headerSubtitle.style.color = '';
                comicTitle.style.color = '';
                comicAlt.style.color = '';
                footerText.style.color = '';
                footerLink.style.color = '';
                footerLicense.style.color = '';
            }
        }

        function displayComic(data) {
            comicTitle.textContent = `#${data.num}: ${data.safe_title}`;
            
            const img = document.createElement('img');
            img.crossOrigin = "Anonymous"; 

            img.onload = () => {
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d', { willReadFrequently: true });
                canvas.width = img.width;
                canvas.height = img.height;
                context.drawImage(img, 0, 0);

                // Sample a pixel from inside the border to get the true background
                const sampleX = Math.min(10, img.width - 1);
                const sampleY = Math.min(10, img.height - 1);
                const pixelData = context.getImageData(sampleX, sampleY, 1, 1).data;
                const backgroundColor = [pixelData[0], pixelData[1], pixelData[2]];
                
                setPageTheme(backgroundColor);

                comicImageWrapper.innerHTML = '';
                comicImageWrapper.appendChild(img);
                comicAlt.textContent = data.alt;
                showComicContainer();
            };

            img.onerror = () => {
                comicImageWrapper.innerHTML = '<p class="text-center text-red-500">Image could not be loaded.</p>';
                comicAlt.textContent = data.alt;
                setPageTheme([248, 250, 252]); // Default to gray-50 on error
                showComicContainer();
            };
            
            img.src = `${PROXY_URL}${encodeURIComponent(data.img)}`;
            img.alt = data.alt;
            img.title = data.alt;
            img.className = 'rounded-lg';
        }

        function showComicContainer() {
            loadingDiv.style.opacity = '0';
            setTimeout(() => {
                loadingDiv.style.display = 'none';
                comicContainer.classList.remove('hidden');
            }, 300);
        }

        document.addEventListener('DOMContentLoaded', fetchRandomComic);
    </script>

</body>
</html>
